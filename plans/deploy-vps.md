# Инструкция по деплою n3rdfeed на VPS (v2.0)

## 1. Подготовка сервера
Убедитесь, что установлены: `docker`, `docker-compose`, `nginx`, `certbot`, `rsync`.

## 2. Настройка Cron (Continuous Listening)
Для реализации стратегии непрерывного сбора данных, парсинг должен запускаться **каждый час**.

Откройте редактор cron:
```bash
crontab -e
```

Добавьте строку (замените домен на свой):
```cron
0 * * * * curl -X POST https://your-domain.com/api/update -H "Content-Type: application/json"
```

## 3. SQL Миграция (Обязательно)
Выполните в консоли Supabase для поддержки Velocity Score и кластеризации:

```sql
-- Включение расширения для векторов
CREATE EXTENSION IF NOT EXISTS vector;

-- Добавление новых полей
ALTER TABLE repositories ADD COLUMN IF NOT EXISTS metrics_history JSONB DEFAULT '[]';
ALTER TABLE repositories ADD COLUMN IF NOT EXISTS embedding vector(1024);

-- Индекс для истории
CREATE INDEX IF NOT EXISTS idx_repositories_metrics_history ON repositories USING gin (metrics_history);

-- Таблица для истории опубликованных дайджестов (Temporal Deduplication)
CREATE TABLE IF NOT EXISTS digest_history (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  published_at timestamp with time zone DEFAULT now(),
  topic_summary text,
  embedding vector(1024)
);
CREATE INDEX IF NOT EXISTS idx_digest_history_published_at ON digest_history (published_at);

-- Настройка безопасности (RLS)
ALTER TABLE digest_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access" ON digest_history
  FOR SELECT USING (true);

CREATE POLICY "Allow service_role insert" ON digest_history
  FOR INSERT WITH CHECK (auth.role() = 'service_role');

-- Функция для семантического поиска (Кластеризация)
CREATE OR REPLACE FUNCTION match_repositories (
  query_embedding vector(1024),
  match_threshold float,
  match_count int,
  min_age_hours int DEFAULT 24
)
RETURNS TABLE (
  id text,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    repositories.id,
    1 - (repositories.embedding <=> query_embedding) AS similarity
  FROM repositories
  WHERE 1 - (repositories.embedding <=> query_embedding) > match_threshold
    AND repositories.created_at > now() - (min_age_hours || ' hours')::interval
  ORDER BY repositories.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

## 4. Деплой
Используйте локальный скрипт для обновления:
```bash
./deploy.sh
```
