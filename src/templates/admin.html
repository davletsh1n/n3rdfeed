<div class="max-w-4xl mx-auto space-y-8">
  <!-- Header & Actions -->
  <div
    class="flex justify-between items-center bg-white p-6 rounded shadow-sm border-l-4 border-black"
  >
    <div>
      <h1 class="text-2xl font-bold uppercase tracking-tighter">N3RDFEED Control Center</h1>
      <p class="text-gray-500 text-xs mt-1">Admin: {{user}}</p>
    </div>
    <div class="flex gap-4 items-center">
      <div
        id="statusIndicator"
        class="hidden items-center gap-2 text-xs font-bold text-blue-600 animate-pulse"
      >
        <span class="w-2 h-2 bg-blue-600 rounded-full"></span>
        PROCESSING...
      </div>
      <button
        onclick="updateContent()"
        id="updateBtn"
        class="bg-black text-white px-4 py-2 hover:bg-gray-800 transition-all uppercase font-bold text-xs"
      >
        Run Manual Update
      </button>
      <button
        onclick="logout()"
        class="bg-red-500 text-white px-4 py-2 hover:bg-red-600 transition-all uppercase font-bold text-xs"
      >
        Logout
      </button>
    </div>
  </div>

  <!-- Live Logs Console -->
  <div
    id="liveLogsContainer"
    class="hidden bg-black text-green-400 p-4 rounded shadow-inner font-mono text-[10px] h-40 overflow-y-auto border-2 border-gray-800 relative group"
  >
    <div id="liveLogs"></div>
    <button
      onclick="toggleLogs()"
      class="absolute top-2 right-2 bg-gray-800 text-gray-400 px-2 py-1 rounded hover:text-white text-[8px] uppercase opacity-0 group-hover:opacity-100 transition-opacity"
    >
      Toggle Size
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    <!-- Model Selection & Rates -->
    <div class="md:col-span-1 bg-white p-6 rounded shadow-sm border-l-4 border-blue-500">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-bold uppercase text-blue-500">LLM Configuration</h2>
        <div class="text-right">
          <div class="text-[8px] text-gray-400 uppercase">Balance</div>
          <div class="text-xs font-bold text-green-600">${{balance}}</div>
        </div>
      </div>
      <div class="space-y-4">
        {{#models}}
        <div
          onclick="selectModel('{{id}}')"
          class="p-3 border rounded cursor-pointer hover:bg-blue-50 transition-colors group relative {{#active}}border-blue-500 bg-blue-50{{/active}}"
        >
          <div class="font-bold text-xs group-hover:text-blue-600">{{name}}</div>
          <div class="text-[10px] text-gray-500 mt-1">
            Prompt: ${{prompt}}/1M<br />
            Completion: ${{completion}}/1M
          </div>
          {{#active}}
          <div class="absolute top-2 right-2 text-[8px] bg-blue-500 text-white px-1 rounded">
            ACTIVE
          </div>
          {{/active}} {{^active}}
          <div
            class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-[8px] bg-gray-500 text-white px-1 rounded"
          >
            SELECT
          </div>
          {{/active}}
        </div>
        {{/models}}
      </div>
    </div>

    <!-- Stats -->
    <div class="md:col-span-2 bg-white p-6 rounded shadow-sm border-l-4 border-green-500">
      <h2 class="font-bold mb-4 uppercase text-green-500">Usage Statistics (30d)</h2>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="border-b text-[10px] text-gray-400 uppercase">
            <th class="py-2">Model</th>
            <th class="py-2">Tokens</th>
            <th class="py-2 text-right">Cost (USD)</th>
          </tr>
        </thead>
        <tbody class="text-xs">
          {{#stats}}
          <tr class="border-b hover:bg-green-50">
            <td class="py-2">{{model}}</td>
            <td class="py-2">{{tokens}}</td>
            <td class="py-2 text-right font-bold">${{cost}}</td>
          </tr>
          {{/stats}}
        </tbody>
      </table>
      <div class="mt-4 text-right">
        <span class="text-[10px] text-gray-400 uppercase">Total Burn:</span>
        <span class="text-lg font-bold ml-2">${{totalCost}}</span>
      </div>
    </div>
  </div>

  <!-- Logs -->
  <div class="bg-white p-6 rounded shadow-sm border-l-4 border-purple-500">
    <h2 class="font-bold mb-4 uppercase text-purple-500">Recent Translation Logs</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="border-b text-[10px] text-gray-400 uppercase">
            <th class="py-2">Time</th>
            <th class="py-2">Model</th>
            <th class="py-2">Tokens</th>
            <th class="py-2 text-right">Cost</th>
          </tr>
        </thead>
        <tbody class="text-[10px]">
          {{#logs}}
          <tr class="border-b hover:bg-purple-50">
            <td class="py-2 text-gray-500">{{time}}</td>
            <td class="py-2">{{model_id}}</td>
            <td class="py-2">{{tokens}}</td>
            <td class="py-2 text-right font-bold">${{cost}}</td>
          </tr>
          {{/logs}}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function addLog(msg, type = 'info') {
    const logs = document.getElementById('liveLogs');
    const container = document.getElementById('liveLogsContainer');
    container.classList.remove('hidden');
    const div = document.createElement('div');
    const time = new Date().toLocaleTimeString();
    div.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="${
      type === 'error' ? 'text-red-400' : 'text-green-400'
    }">${msg}</span>`;
    logs.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function toggleLogs() {
    const container = document.getElementById('liveLogsContainer');
    if (container.classList.contains('h-40')) {
      container.classList.remove('h-40');
      container.classList.add('h-96');
    } else {
      container.classList.add('h-40');
      container.classList.remove('h-96');
    }
  }

  function logout() {
    const url = location.protocol + '//' + 'logout:logout@' + location.host + '/admin';
    fetch(url)
      .then(() => {
        location.href = '/';
      })
      .catch(() => {
        location.href = '/';
      });
  }

  async function selectModel(modelId) {
    try {
      const res = await fetch('/api/admin/set-model', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ modelId }),
      });
      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert('Failed to set model');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  async function updateContent() {
    const btn = document.getElementById('updateBtn');
    const status = document.getElementById('statusIndicator');
    const originalText = btn.innerText;
    const logsDiv = document.getElementById('liveLogs');
    const container = document.getElementById('liveLogsContainer');

    btn.disabled = true;
    btn.innerText = 'Updating...';
    btn.classList.add('opacity-50');
    status.classList.remove('hidden');
    status.classList.add('flex');
    container.classList.remove('hidden');
    logsDiv.innerHTML = '';

    addLog('Starting manual update process...');

    try {
      const res = await fetch('/api/update', { method: 'POST' });
      const data = await res.json();

      if (data.logs && Array.isArray(data.logs)) {
        data.logs.forEach((log) => addLog(log.replace(/\[.*?\] /, '')));
      }

      if (data.success) {
        addLog('Update successful! Page will reload in 5s...');
        setTimeout(() => location.reload(), 5000);
      } else {
        addLog('Update failed: ' + (data.errors?.[0]?.message || 'Unknown error'), 'error');
      }
    } catch (err) {
      addLog('Network error: ' + err.message, 'error');
    } finally {
      btn.disabled = false;
      btn.innerText = originalText;
      btn.classList.remove('opacity-50');
      status.classList.add('hidden');
      status.classList.remove('flex');
    }
  }
</script>
